<div class="transfers-table-container">
    @if (showFilters) {
        <div class="mb-4 flex items-center rounded-lg border border-gray-200 bg-white p-3 shadow-sm sm:p-2 md:p-3">
            <div class="mr-5 inline-flex items-center gap-2">
                <input
                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    id="showAllCheckbox"
                    [ngModel]="filter.showPlanned"
                    (ngModelChange)="showAllChecked($event)"
                    type="checkbox"
                />
                <label class="mb-0 cursor-pointer select-none text-sm font-medium text-gray-700" for="showAllCheckbox">Show planned transfers</label>
            </div>
            <div class="mr-5 inline-flex items-center gap-2">
                <input
                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    id="showFlaggedCheckbox"
                    [ngModel]="filter.showFlagged"
                    (ngModelChange)="showFlaggedChecked($event)"
                    type="checkbox"
                />
                <label class="mb-0 cursor-pointer select-none text-sm font-medium text-gray-700" for="showFlaggedCheckbox">Only flagged transfers</label>
            </div>
            @if (enableBulkActions) {
                <div class="mr-5 inline-flex items-center gap-2">
                    <input
                        class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        id="bulkEditModeCheckbox"
                        [(ngModel)]="isBulkEditMode"
                        (ngModelChange)="onBulkEditModeChanged()"
                        type="checkbox"
                    />
                    <label class="mb-0 cursor-pointer select-none text-sm font-medium text-gray-700" for="bulkEditModeCheckbox">Bulk Edit Mode</label>
                </div>
            }
        </div>
    }
    @if (showFilters && lastPageNumber) {
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                @if (enableBulkActions && isBulkEditMode && selectedTransferIds.size > 0) {
                    <div class="flex items-center space-x-4 rounded-md border border-blue-200 bg-blue-50 px-3 py-1">
                        <span class="text-sm font-medium text-blue-900">
                            {{ selectedTransferIds.size }} transfer{{ selectedTransferIds.size === 1 ? '' : 's' }} selected
                        </span>
                        <button class="text-xs text-blue-600 underline hover:text-blue-800" (click)="clearSelection()">Clear</button>
                        <div class="flex items-center space-x-1">
                            <app-button-icon [icon]="editIcon" (clicked)="openBulkEditModal()" size="sm" ariaLabel="Bulk edit transfers"></app-button-icon>
                            <app-button-icon
                                [icon]="trashIcon"
                                (clicked)="confirmBulkDelete()"
                                size="sm"
                                variant="ghost"
                                ariaLabel="Delete selected transfers"
                            ></app-button-icon>
                        </div>
                    </div>
                }
            </div>
            <app-pagination [lastPage]="lastPageNumber" (pageChange)="onPageChanged($event)"></app-pagination>
        </div>
    }
    <table class="transfers-table">
        @if (isHeaderDisplayed) {
            <caption>
                <span>{{ header }}</span>
            </caption>
        }
        <thead>
            <tr>
                @if (enableBulkActions && isBulkEditMode) {
                    <th class="w-12">
                        <input
                            class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                            [checked]="isAllSelected"
                            [indeterminate]="isPartiallySelected"
                            (change)="toggleSelectAll($event)"
                            type="checkbox"
                            title="Select all transfers"
                        />
                    </th>
                }
                <th class="text-left">
                    <span>Category</span>
                    @if (showFilters) {
                        <app-table-filter
                            [filterName]="TableColumn.Category"
                            [filterType]="FilterType.MultiCheckbox"
                            [filterOptions]="optionsForCheckboxFilters.categories"
                            [popupSide]="PopupSide.ToRight"
                            [cachedFilterValue]="filter.category"
                            (filterEvent)="onPerformFilter($event)"
                        ></app-table-filter>
                    }
                </th>
                <th>
                    <span>Description</span>
                    @if (showFilters) {
                        <app-table-filter
                            [filterName]="TableColumn.Description"
                            [filterType]="FilterType.TextBox"
                            [popupSide]="PopupSide.ToLeft"
                            [cachedFilterValue]="filter.description"
                            (filterEvent)="onPerformFilter($event)"
                        ></app-table-filter>
                    }
                </th>
                <th class="text-right">
                    <span>Source Account</span>
                    @if (showFilters) {
                        <app-table-filter
                            [filterName]="TableColumn.Account"
                            [filterType]="FilterType.MultiCheckbox"
                            [filterOptions]="optionsForCheckboxFilters.accounts"
                            [popupSide]="PopupSide.ToLeft"
                            [cachedFilterValue]="filter.account"
                            (filterEvent)="onPerformFilter($event)"
                        ></app-table-filter>
                    }
                </th>
                <th class="text-right">
                    <span>Amount</span>
                    @if (showFilters) {
                        <app-table-filter
                            [filterName]="TableColumn.Amount"
                            [filterType]="FilterType.NumericRange"
                            [popupSide]="PopupSide.ToLeft"
                            (filterEvent)="onPerformFilter($event)"
                        ></app-table-filter>
                    }
                </th>
                <th>
                    <span>Contractor</span>
                    @if (showFilters) {
                        <app-table-filter
                            [filterName]="TableColumn.Contractor"
                            [filterType]="FilterType.MultiCheckbox"
                            [filterOptions]="optionsForCheckboxFilters.contractors"
                            [popupSide]="PopupSide.ToLeft"
                            [cachedFilterValue]="filter.contractor"
                            (filterEvent)="onPerformFilter($event)"
                        ></app-table-filter>
                    }
                </th>
                <th class="text-right">
                    <span>Date</span>
                    @if (showFilters) {
                        <app-table-filter
                            [filterName]="TableColumn.Date"
                            [filterType]="FilterType.DateRange"
                            [popupSide]="PopupSide.ToLeft"
                            (filterEvent)="onPerformFilter($event)"
                        ></app-table-filter>
                    }
                </th>
            </tr>
        </thead>
        <tbody>
            @for (transfer of transfersForTable; track transferIdTracker($index, transfer)) {
                <tr [ngClass]="getTransferRowClass(transfer)">
                    @if (!transfer.isTodayMarkerRow) {
                        @if (enableBulkActions && isBulkEditMode) {
                            <td>
                                <input
                                    class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                                    [checked]="isTransferSelected(transfer.id)"
                                    (change)="toggleTransferSelection(transfer.id, $event)"
                                    type="checkbox"
                                />
                            </td>
                        }
                        <td>{{ transfer.categoryName }}</td>
                        <td>
                            <a [routerLink]="CoinageRoutes.TransferDetailsPage.getUrl({ id: transfer.id })">
                                {{ transfer.description }}
                            </a>
                            @if (transfer.receiptId) {
                                <span class="planned-icon">
                                    <a [routerLink]="CoinageRoutes.ReceiptDetailsPage.getUrl({ id: transfer.receiptId })">
                                        <fa-icon [icon]="receiptIcon" [fixedWidth]="true" title="View receipt"></fa-icon>
                                    </a>
                                </span>
                            }
                            @if (transfer.isFlagged) {
                                <span class="planned-icon">
                                    <fa-icon [icon]="flagIcon" [fixedWidth]="true" title="Flagged as important"></fa-icon>
                                </span>
                            }
                        </td>
                        <td>{{ transfer.accountName }}</td>
                        <td class="currency whitespace-nowrap">
                            <app-money-amount
                                [transferData]="getTransferValueDetails(transfer)"
                                [transferAccounts]="getTransferAccountDetails(transfer)"
                            ></app-money-amount>
                        </td>
                        <td>
                            {{ transfer.contractorName | ifNull: EMPTY_CONTRACTOR }}
                        </td>
                        <!-- <td colspan="2">
            <app-money-amount [accountToAccountTransfer]="getTransferValueDetails(transfer)"></app-money-amount>
          </td> -->
                        <td class="whitespace-nowrap text-right">
                            <a [routerLink]="getSummaryPageUrl(transfer)">{{ transfer.date | date }}</a>
                        </td>
                    }
                </tr>
            }
            @if (showSummary && !noRows && outcomesCount > 0) {
                <tr class="sum-row top-border">
                    @if (enableBulkActions && isBulkEditMode) {
                        <td></td>
                    }
                    <td colspan="2">Expenses Sum</td>
                    <td>{{ outcomesCount }}</td>
                    <td class="currency">{{ outcomesSum | plnCurrency }}</td>
                    <td colspan="2"></td>
                </tr>
            }
            @if (showSummary && !noRows && incomesCount > 0) {
                <tr class="sum-row">
                    @if (enableBulkActions && isBulkEditMode) {
                        <td></td>
                    }
                    <td colspan="2">Incomes Sum</td>
                    <td>{{ incomesCount }}</td>
                    <td class="currency">{{ incomesSum | plnCurrency }}</td>
                    <td colspan="2"></td>
                </tr>
            }
            @if (noRowsFound) {
                <tr>
                    <td [attr.colspan]="enableBulkActions && isBulkEditMode ? 7 : 6">
                        <span>No transfers found.</span>
                        @if (isAnyFilterApplied && !noRows) {
                            <span> Please check filters, there are {{ transfers?.length }} unmatched transfers. </span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
    @if (showFilters && lastPageNumber) {
        <div class="mt-2 flex items-center justify-between">
            <div class="flex items-center space-x-4">
                @if (enableBulkActions && isBulkEditMode && selectedTransferIds.size > 0) {
                    <div class="flex items-center space-x-4 rounded-md border border-blue-200 bg-blue-50 px-3 py-1">
                        <span class="text-sm font-medium text-blue-900">
                            {{ selectedTransferIds.size }} transfer{{ selectedTransferIds.size === 1 ? '' : 's' }} selected
                        </span>
                        <button class="text-xs text-blue-600 underline hover:text-blue-800" (click)="clearSelection()">Clear</button>
                        <div class="flex items-center space-x-1">
                            <app-button-icon [icon]="editIcon" (clicked)="openBulkEditModal()" size="sm" ariaLabel="Bulk edit transfers"></app-button-icon>
                            <app-button-icon
                                [icon]="trashIcon"
                                (clicked)="confirmBulkDelete()"
                                size="sm"
                                variant="ghost"
                                ariaLabel="Delete selected transfers"
                            ></app-button-icon>
                        </div>
                    </div>
                }
            </div>
            <app-pagination [lastPage]="lastPageNumber" [currentPage]="currentPage"></app-pagination>
        </div>
    }
</div>

<!-- Bulk Edit Modal -->
<app-modal [isDisplayed]="isBulkEditModalOpen" [moveable]="true" [centered]="true" (hideModalEvent)="onBulkEditModalClose()">
    <app-bulk-edit-transfers-modal
        [isDisplayed]="isBulkEditModalOpen"
        [selectedTransferIds]="Array.from(selectedTransferIds)"
        [isInsideModal]="true"
        (closeModal)="onBulkEditModalClose()"
        (bulkEditComplete)="onBulkEditComplete()"
    ></app-bulk-edit-transfers-modal>
</app-modal>
